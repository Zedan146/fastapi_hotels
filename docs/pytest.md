# üß™ Pytest - –®–ø–∞—Ä–≥–∞–ª–∫–∞

## –û—Å–Ω–æ–≤—ã Pytest

Pytest - —ç—Ç–æ –º–æ—â–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –ø—Ä–æ—Å—Ç—ã–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º –∏ –±–æ–≥–∞—Ç—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏.

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
pip install pytest pytest-asyncio pytest-cov
```

## –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç—ã
```python
# test_basic.py
def test_addition():
    assert 2 + 2 == 4

def test_string_concatenation():
    assert "hello" + " " + "world" == "hello world"

def test_list_operations():
    my_list = [1, 2, 3]
    assert len(my_list) == 3
    assert 2 in my_list
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
pytest test_basic.py

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest -v

# –ó–∞–ø—É—Å–∫ —Å –≤—ã–≤–æ–¥–æ–º print
pytest -s

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
pytest test_basic.py::test_addition
```

## –§–∏–∫—Å—Ç—É—Ä—ã (Fixtures)

### –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
```python
import pytest

@pytest.fixture
def sample_data():
    return {"name": "John", "age": 30, "city": "New York"}

def test_user_data(sample_data):
    assert sample_data["name"] == "John"
    assert sample_data["age"] == 30

@pytest.fixture
def numbers():
    return [1, 2, 3, 4, 5]

def test_numbers_sum(numbers):
    assert sum(numbers) == 15
```

### –§–∏–∫—Å—Ç—É—Ä—ã —Å –æ–±–ª–∞—Å—Ç—å—é –≤–∏–¥–∏–º–æ—Å—Ç–∏
```python
@pytest.fixture(scope="session")
def database_connection():
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î (–æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é)
    conn = create_connection()
    yield conn
    conn.close()

@pytest.fixture(scope="module")
def api_client():
    # –°–æ–∑–¥–∞–Ω–∏–µ API –∫–ª–∏–µ–Ω—Ç–∞ (–æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –º–æ–¥—É–ª—å)
    client = APIClient()
    yield client
    client.close()

@pytest.fixture(scope="function")
def temp_file():
    # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç)
    file = tempfile.NamedTemporaryFile()
    yield file
    file.close()
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
```python
@pytest.fixture(autouse=True)
def setup_test_environment():
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
    setup_environment()
    yield
    cleanup_environment()
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
```python
@pytest.fixture(params=[1, 2, 3])
def number(request):
    return request.param

def test_number_is_positive(number):
    assert number > 0

# –ò–ª–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
@pytest.fixture(params=[
    ("admin", "admin123"),
    ("user", "user123"),
    ("guest", "guest123")
])
def user_credentials(request):
    return request.param

def test_login(user_credentials):
    username, password = user_credentials
    assert len(username) > 0
    assert len(password) > 0
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —Å @pytest.mark.parametrize
```python
import pytest

@pytest.mark.parametrize("input,expected", [
    (2, 4),
    (3, 9),
    (4, 16),
    (5, 25)
])
def test_square(input, expected):
    assert input ** 2 == expected

@pytest.mark.parametrize("username,password,expected", [
    ("admin", "admin123", True),
    ("user", "wrongpass", False),
    ("", "password", False),
    ("user", "", False)
])
def test_login_validation(username, password, expected):
    result = validate_login(username, password)
    assert result == expected
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —Å —Ñ–∏–∫—Å—Ç—É—Ä–∞–º–∏
```python
@pytest.fixture(params=["chrome", "firefox", "safari"])
def browser(request):
    return create_browser(request.param)

def test_website_compatibility(browser):
    assert browser.load_website() == "success"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
```python
import pytest

def test_division_by_zero():
    with pytest.raises(ZeroDivisionError):
        1 / 0

def test_invalid_input():
    with pytest.raises(ValueError, match="Invalid input"):
        process_input("invalid")

def test_multiple_exceptions():
    with pytest.raises((ValueError, TypeError)):
        risky_operation("bad_input")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
```python
import warnings

def test_deprecated_function():
    with pytest.warns(DeprecationWarning):
        deprecated_function()

def test_specific_warning():
    with pytest.warns(UserWarning, match="This is a warning"):
        function_that_warns()
```

## –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ async —Ñ—É–Ω–∫—Ü–∏–π
```python
import pytest
import asyncio

@pytest.mark.asyncio
async def test_async_function():
    result = await async_function()
    assert result == "expected_result"

@pytest.mark.asyncio
async def test_async_with_fixture(async_fixture):
    result = await async_function(async_fixture)
    assert result is not None

@pytest.fixture
async def async_fixture():
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞
    data = await fetch_data()
    yield data
    await cleanup_data(data)
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FastAPI
```python
from fastapi.testclient import TestClient
from fastapi import FastAPI

app = FastAPI()

@pytest.fixture
def client():
    return TestClient(app)

def test_read_main(client):
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}

def test_create_item(client):
    response = client.post("/items/", json={"name": "Test Item"})
    assert response.status_code == 200
    assert response.json()["name"] == "Test Item"
```

## –ú–æ–∫–∏ –∏ –∑–∞–≥–ª—É—à–∫–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ unittest.mock
```python
from unittest.mock import Mock, patch, MagicMock
import pytest

def test_mock_function():
    # –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–∫–∞
    mock_func = Mock(return_value="mocked_result")
    
    result = mock_func()
    assert result == "mocked_result"
    mock_func.assert_called_once()

def test_patch_function():
    with patch('module.function') as mock_func:
        mock_func.return_value = "patched_result"
        
        result = call_function()
        assert result == "patched_result"

@pytest.fixture
def mock_database():
    mock_db = Mock()
    mock_db.query.return_value.filter.return_value.first.return_value = {"id": 1, "name": "Test"}
    return mock_db

def test_database_query(mock_database):
    result = mock_database.query("users").filter("id=1").first()
    assert result["name"] == "Test"
```

### –ü–∞—Ç—á–∏–Ω–≥ –≤ —Ñ–∏–∫—Å—Ç—É—Ä–∞—Ö
```python
@pytest.fixture
def mock_requests():
    with patch('requests.get') as mock_get:
        mock_get.return_value.json.return_value = {"status": "success"}
        yield mock_get

def test_api_call(mock_requests):
    response = make_api_call()
    assert response["status"] == "success"
    mock_requests.assert_called_once()
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å SQLAlchemy
```python
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

@pytest.fixture
def db_session():
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –≤ –ø–∞–º—è—Ç–∏
    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = SessionLocal()
    
    yield session
    session.close()

def test_create_user(db_session):
    user = User(name="John", email="john@example.com")
    db_session.add(user)
    db_session.commit()
    
    assert user.id is not None
    assert user.name == "John"

def test_get_user(db_session):
    user = User(name="Jane", email="jane@example.com")
    db_session.add(user)
    db_session.commit()
    
    found_user = db_session.query(User).filter(User.email == "jane@example.com").first()
    assert found_user.name == "Jane"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å pytest-postgresql
```python
import pytest
from pytest_postgresql import factories

# –§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
postgresql_proc = factories.postgresql_proc()
postgresql = factories.postgresql("postgresql_proc")

def test_database_operations(postgresql):
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π PostgreSQL
    with postgresql.cursor() as cursor:
        cursor.execute("CREATE TABLE test (id SERIAL PRIMARY KEY, name VARCHAR(50))")
        cursor.execute("INSERT INTO test (name) VALUES ('test')")
        cursor.execute("SELECT * FROM test")
        result = cursor.fetchone()
        assert result[1] == "test"
```

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```bash
pip install pytest-cov
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
```bash
# –ë–∞–∑–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
pytest --cov=src

# –ü–æ–∫—Ä—ã—Ç–∏–µ —Å HTML –æ—Ç—á–µ—Ç–æ–º
pytest --cov=src --cov-report=html

# –ü–æ–∫—Ä—ã—Ç–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º
pytest --cov=src --cov-fail-under=80

# –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
pytest --cov=src.models --cov=src.services
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ pytest.ini
```ini
[tool:pytest]
addopts = --cov=src --cov-report=html --cov-report=term-missing
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

## –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
```python
# pytest.ini
[tool:pytest]
markers =
    slow: marks tests as slow
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    smoke: marks tests as smoke tests
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
```python
import pytest

@pytest.mark.slow
def test_heavy_computation():
    # –î–æ–ª–≥–∏–π —Ç–µ—Å—Ç
    result = heavy_computation()
    assert result > 0

@pytest.mark.integration
def test_database_integration():
    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
    pass

@pytest.mark.unit
def test_unit_function():
    # –Æ–Ω–∏—Ç —Ç–µ—Å—Ç
    pass

@pytest.mark.smoke
def test_basic_functionality():
    # –î—ã–º–æ–≤–æ–π —Ç–µ—Å—Ç
    pass
```

### –ó–∞–ø—É—Å–∫ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest -m "not slow"

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest -m integration

# –ó–∞–ø—É—Å–∫ –¥—ã–º–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest -m smoke
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### pytest.ini
```ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    -v
    --tb=short
    --strict-markers
    --disable-warnings
markers =
    slow: marks tests as slow
    integration: marks tests as integration tests
```

### conftest.py
```python
import pytest
import asyncio
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
@pytest.fixture(scope="session")
def event_loop():
    """–°–æ–∑–¥–∞–Ω–∏–µ event loop –¥–ª—è –≤—Å–µ–π —Å–µ—Å—Å–∏–∏"""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()

@pytest.fixture(scope="session")
def database_engine():
    """–°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–∫–∞ –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    engine = create_engine("sqlite:///:memory:")
    Base.metadata.create_all(engine)
    yield engine
    engine.dispose()

@pytest.fixture
def db_session(database_engine):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞"""
    SessionLocal = sessionmaker(bind=database_engine)
    session = SessionLocal()
    yield session
    session.rollback()
    session.close()
```

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏

### –ü—Ä–æ–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```python
import pytest

@pytest.mark.skip(reason="Feature not implemented yet")
def test_future_feature():
    assert False

@pytest.mark.skipif(not hasattr(os, "getuid"), reason="Unix only")
def test_unix_feature():
    assert os.getuid() >= 0

def test_conditional_skip():
    if not check_condition():
        pytest.skip("Condition not met")
    assert True
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Å–±–æ–∏
```python
@pytest.mark.xfail(reason="Known issue")
def test_known_bug():
    assert False

@pytest.mark.xfail(strict=True)
def test_strict_xfail():
    assert True  # –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª
```

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
```python
def assert_user_has_required_fields(user):
    """–ö–∞—Å—Ç–æ–º–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    required_fields = ["id", "name", "email"]
    for field in required_fields:
        assert hasattr(user, field), f"User missing required field: {field}"
    assert user.id > 0, "User ID must be positive"
    assert "@" in user.email, "Email must contain @"

def test_user_creation():
    user = create_user("John", "john@example.com")
    assert_user_has_required_fields(user)
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —Å —Ñ–∏–∫—Å—Ç—É—Ä–∞–º–∏
```python
@pytest.fixture(params=["sqlite", "postgresql"])
def database_url(request):
    if request.param == "sqlite":
        return "sqlite:///:memory:"
    elif request.param == "postgresql":
        return "postgresql://user:pass@localhost/testdb"

def test_database_operations(database_url):
    # –¢–µ—Å—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –ë–î
    engine = create_engine(database_url)
    # ... —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤
```
tests/
‚îú‚îÄ‚îÄ conftest.py
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_models.py
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py
‚îÇ   ‚îî‚îÄ‚îÄ test_utils.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py
‚îÇ   ‚îî‚îÄ‚îÄ test_database.py
‚îî‚îÄ‚îÄ fixtures/
    ‚îú‚îÄ‚îÄ users.json
    ‚îî‚îÄ‚îÄ hotels.json
```

### 2. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
```python
# –•–æ—Ä–æ—à–æ
def test_user_creation_with_valid_data():
    pass

def test_user_creation_with_invalid_email_raises_error():
    pass

# –ü–ª–æ—Ö–æ
def test1():
    pass

def test_user():
    pass
```

### 3. –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
```python
@pytest.fixture(autouse=True)
def clean_database():
    # –û—á–∏—Å—Ç–∫–∞ –ë–î –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
    clean_all_tables()
    yield
    clean_all_tables()
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
```python
def test_invalid_input_raises_error():
    with pytest.raises(ValueError) as exc_info:
        process_invalid_input()
    assert "Invalid input" in str(exc_info.value)
```

### 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
```python
@pytest.fixture
def sample_user():
    return {
        "name": "John Doe",
        "email": "john@example.com",
        "age": 30
    }

def test_user_processing(sample_user):
    result = process_user(sample_user)
    assert result["processed"] is True
```
